name: CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy:
        description: "Deploy to production"
        required: true
        type: boolean
        default: true

permissions:
  contents: read

concurrency:
  group: deploy-prod
  cancel-in-progress: false

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 22
          cache: npm
      - run: npm ci
      - run: npx tsc --noEmit
      - run: npx vitest run

  deploy:
    needs: check
    if: github.event_name == 'workflow_dispatch' && inputs.deploy
    runs-on: ubuntu-latest
    environment: production
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      ALLOWED_ORIGINS: ${{ secrets.ALLOWED_ORIGINS }}
      WORKOS_API_KEY: ${{ secrets.WORKOS_API_KEY }}
      WORKOS_CLIENT_ID: ${{ secrets.WORKOS_CLIENT_ID }}
      BASE_URL: ${{ secrets.BASE_URL }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: google-github-actions/auth@c200f3691d83b41bf9bbd8638997a462592937ed # v2.1.13
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: google-github-actions/setup-gcloud@77e7a554d41e2ee56fc945c52dfd3f33d12def9a # v2.1.4

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy gym-tracker \
            --source . \
            --region us-central1 \
            --allow-unauthenticated \
            --port 3001 \
            --memory 256Mi \
            --cpu 1 \
            --min-instances 0 \
            --max-instances 1 \
            --set-env-vars "DATABASE_URL=$DATABASE_URL,ALLOWED_ORIGINS=$ALLOWED_ORIGINS,WORKOS_API_KEY=$WORKOS_API_KEY,WORKOS_CLIENT_ID=$WORKOS_CLIENT_ID,BASE_URL=$BASE_URL" \
            --quiet
